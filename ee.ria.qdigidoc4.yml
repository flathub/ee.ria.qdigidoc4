app-id: ee.ria.qdigidoc4
command: run.sh
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
rename-icon: qdigidoc4
rename-mime-file: qdigidoc4.xml
rename-mime-icons: ["application-x-cdoc","application-vnd.etsi.asic-e+zip"]

finish-args:
  # libdigidocpp stores tsl files here
  - --persist=.digidocpp
  # Network is needed for some parts of the application's functionality
  - --share=network
  # Wayland
  - --socket=wayland
  # X11
  - --socket=fallback-x11
  - --share=ipc
  # Smartcard
  - --socket=pcsc
  - --device=all
  - --filesystem=home

cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /etc/bash_completion.d
  - /share/doc
  - /share/man

modules:
  - name: flatbuffers
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/google/flatbuffers/archive/refs/tags/v25.2.10.zip
        sha256: 75ffbce7d32f8218b5faec86ae2f6397c7ca810605dc710dfa9c146b9df9e3e9

  - name: xmlsec
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/lsh123/xmlsec/releases/download/1.3.7/xmlsec1-1.3.7.tar.gz
        sha256: d82e93b69b8aa205a616b62917a269322bf63a3eaafb3775014e61752b2013ea
      - type: patch
        paths:
          - xmlsec/xmlsec1-1.3.5.legacy.patch
          - xmlsec/xmlsec1-1.3.7.ecdsa-sig.patch
          - xmlsec/xmlsec1-1.3.7.rsapss.patch

  - name: libdigidocpp
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/open-eid/libdigidocpp/archive/refs/tags/v4.2.1.tar.gz
        sha256: e050fbaf845c90f3fd6df4594530df3cd831f58e3b93eac5e345ffa65b17c2da

  - name: openldap
    buildsystem: autotools
    config-opts:
      - --disable-backends
      - --disable-overlays
      - --disable-slapd
      - --disable-debug
      - --enable-dynamic
      - --without-threads
      - --with-tls=gnutls
    cleanup:
      - /bin
      - /share/man
    sources:
      - type: archive
        url: https://www.openldap.org/software/download/OpenLDAP/openldap-release/openldap-2.6.10.tgz
        sha256: c065f04aad42737aebd60b2fe4939704ac844266bc0aeaa1609f0cad987be516
      - type: script
        dest-filename: autogen.sh
        commands:
          - AUTOMAKE=/bin/true autoreconf -vfi

  - shared-modules/libusb/libusb.json

  - name: pcsc-lite
    config-opts:
      - --disable-libudev
      - --disable-libsystemd
      - --without-systemdsystemunitdir
      - --disable-serial
      - --disable-usb
      - --disable-documentation
      - --disable-polkit
    cleanup:
      - /sbin
    sources:
      - type: archive
        url: https://github.com/LudovicRousseau/PCSC/archive/refs/tags/2.3.3.tar.gz
        sha256: 00b667aa71504ed1d39a48ad377de048c70dbe47229e8c48a3239ab62979c70f
      - type: patch
        path: pcsc-lite/negotiate_protocol.diff

  - name: opensc
    cleanup:
      - /share/applications/org.opensc.notify.desktop
    sources:
      - type: archive
        url: https://github.com/OpenSC/OpenSC/releases/download/0.26.1/opensc-0.26.1.tar.gz
        sha256: f16291a031d86e570394762e9f35eaf2fcbc2337a49910f3feae42d54e1688cb

  - name: qdigidoc4
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/open-eid/DigiDoc4-Client/releases/download/v4.8.2/qdigidoc4_4.8.2.5377-2404.tar.xz
        sha256: 43f7fc442f637baf441ecf47e3fc72afc05ccec24b00025aa6c00bb4f6244312
      - type: patch
        path: qdigidoc4/QPKCS11.patch
      - type: file
        path: ee.ria.qdigidoc4.metainfo.xml
      # See guide for building in a sandboxed environment:
      # https://github.com/open-eid/DigiDoc4-Client/wiki/DeveloperTips#building-in-sandboxed-environment
      - type: file
        url: https://ec.europa.eu/tools/lotl/eu-lotl.xml
        sha256: bb231cec463aa19f353b2de88fafc37f1312622a5ed973a626628eb73368d440
        dest: client
        dest-filename: eu-lotl.xml
      - type: file
        url: https://sr.riik.ee/tsl/estonian-tsl.xml
        sha256: e35d2b0b56c91e62905e458a4d7921e610f0ec8294dec94c91a59747e0aac0dd
        dest: client
        dest-filename: EE.xml
      - type: file
        url: https://id.eesti.ee/config.json
        sha256: 5d1011bdee664c2031859c6c1be9f668cb923e1e0b5b96998e2d7c7fda864b10
        dest: common
        dest-filename: config.json
      - type: file
        url: https://id.eesti.ee/config.rsa
        sha256: fd2c14b30d25d72861f2b8df493bd5b5ba9fd06334c3f6fc5b429d70cc01225f
        dest: common
        dest-filename: config.rsa
      - type: file
        url: https://id.eesti.ee/config.pub
        sha256: 29e05778ce98b5197963266bdc292af80a9406cccc3fe5ef7ca2b75b1beb34eb
        dest: common
        dest-filename: config.pub
      # qdigidoc4 saves files in $TMPDIR before opening them. Since this is inaccessible, we provide a wrapper script,
      # as advised here: https://docs.flatpak.org/en/latest/sandbox-permissions.html#filesystem-access
      - type: script
        dest-filename: run.sh
        commands:
          - env TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID" qdigidoc4 "$@"
    post-install:
      - install run.sh "${FLATPAK_DEST}/bin/run.sh"
      - install -Dm644 ee.ria.qdigidoc4.metainfo.xml $FLATPAK_DEST/share/metainfo/ee.ria.qdigidoc4.metainfo.xml
      - ln -s $FLATPAK_DEST/share/locale/et/LC_MESSAGES/nautilus-qdigidoc.mo $FLATPAK_DEST/share/locale/et/nautilus-qdigidoc.mo
      - ln -s $FLATPAK_DEST/share/locale/ru/LC_MESSAGES/nautilus-qdigidoc.mo $FLATPAK_DEST/share/locale/ru/nautilus-qdigidoc.mo
      - desktop-file-edit --set-key=Exec --set-value="run.sh" /app/share/applications/ee.ria.qdigidoc4.desktop
